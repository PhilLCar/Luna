# File: makefile

.SUFFIXES:
.SUFFIXES: .scm .s .c .o .exe

PDFLATEX=pdflatex
MKFILE_PATH:=$(dir $(abspath $(lastword $(MAKEFILE_LIST))))

all: mmap.o stdio.o exio.o gc.o port.o
	@echo "Please add $(MKFILE_PATH) to your PATH to use Ceres from any folder"
	@echo "You can do this by executing :"
	@echo '	% export PATH=$(MKFILE_PATH):$$PATH'

.s.o.c:
	gcc -c -o $*.s $*.o $*.c

test: ut rt et

ut: mmap.o stdio.o exio.o gc.o port.o
	./run-unit-tests.scm

rt: 
	./run-unit-tests.scm -rc

et:
	./run-unit-tests.scm -ec

clean: cleanrapport
	rm -f *.o *.ir *.exe *.out.s *~ unit-tests/*.s unit-tests/*.exe unit-tests/*~ unit-tests/*.ir

cleanrapport:
	rm -f *.aux *.log *.pdf *.out

cleansubfiles:
	rm -f *.ir *.out.s *.aux *.log unit-tests/*.s unit-tests/*.ir

cleancompile: cleansubfiles
	rm -f *.exe unit-tests/*.exe

rapport: etape1.pdf etape2.pdf etape3.pdf

.SUFFIXES: .tex .pdf

.tex.pdf:
	$(PDFLATEX) $*.tex

help:
	@echo "MAKE COMMANDS"
	@echo ""
	@echo "Compiling"
	@echo "========="
	@echo "    all     : compiles the compiler's source files"
	@echo "    test    : compiles and runs all unitary tests"
	@echo "    rapport : compiles .tex files to pdf"
	@echo ""
	@echo "Cleaning"
	@echo "========"
	@echo "    clean         : cleans all generated files"
	@echo "    cleanrapport  : cleans .tex related subfiles"
	@echo "    cleansubfiles : cleans byproducts of compiling (.ir, .out.s, .log and .aux files)"
	@echo "    cleancompile  : cleans all compiler generated files (keeps the compiler usable)"

h: help
